<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width initial-scale=1.0">
    <title>Title</title>
    <!-- 폰트 -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding&family=Noto+Sans&family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <!--
    한글 폰트
    font-family: 'Nanum Gothic Coding', monospace;
    font-family: 'Noto Sans KR', sans-serif;
    영문 폰트
    font-family: 'Noto Sans', sans-serif;

    보통은(한/영 둘다) Noto Sans로 하고
    정보표시는 Nanum Gothic Coding.
    -->
    <!-- fontawesome CDN -->
    <script src="https://kit.fontawesome.com/88eb152a32.js" crossorigin="anonymous"></script>
    <!-- css -->
    <link rel="stylesheet" href="/css/reset.css" />
    <link rel="stylesheet" href="/css/member/mypage-style.css" />
    <!-- 스크립트 -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
    <script src="/js/reset.js"></script>
    <script src="/js/member/member.js"></script>
</head>
<body>
<header th:replace="header.html"></header>
<div class="content-container mypage">
    <div class="nav">
        <ul>
            <li class="myinfo menu-hover">내정보</li>
            <li class="cart menu-hover">장바구니</li>
            <li class="order menu-hover">주문내역</li>
            <li class="request menu-hover">1:1문의</li>
        </ul>
    </div>
    <div class="content myinfo pop">
        <div class="auth">
            <input type="password" placeholder="비밀번호를 한번 더 입력해주세요"/>
            <button class="btn auth">확인</button>
        </div>
        <div class="info">
            <form id="edit-info" class="edit-info" action="#" method="PUT">
                <input class="memberLoginId" type="text" placeholder="아이디" disabled />
                <input class="memberEmail" type="text" placeholder="이메일" disabled/>
                <input class="memberPw" name="memberPw" type="password" placeholder="비밀번호" />
                <input class="memberPwConfirm" type="password" placeholder="비밀번호 확인" />
                <span class="alert-small">비밀번호는 영문 + 숫자  6글자 이상 (특수문자 불가능)</span>
                <div class="div-name">
                    <input class="memberName" type="text" name="memberName" placeholder="이름" />
                    <span class="chksum name true"></span>
                </div>
                <input class="memberTel" type="text" name="memberTel" placeholder="전화번호" />
                <div class="addr">
                    <input type="text" id="zipcode" class="memberZipcode" name="memberZipCode" placeholder="우편번호" readonly>
                    <input type="button" class="searchZipCode" onclick="searchZipCode()" value="우편번호 찾기"><br>
                    <input type="text" id="address" class="memberAddress add" name="memberAddress" placeholder="주소" readonly><br>
                </div>
                <div class="div-detailaddr">
                    <input type="text" id="detailAddress" class="memberDetailAddress add" name="memberDetailAddress" placeholder="상세주소">
                    <span class="chksum detailaddr true"></span>
                </div>
                <div class="btns">
                    <button class="btn edit">수정</button>
                    <button class="btn delete">회원탈퇴</button>
                </div>
            </form>
        </div>
    </div>
    <div class="content cart">
        장바구니
    </div>
    <div class="content order">
        주문내역
    </div>
    <div class="content request">
        1:1문의
    </div>
</div>
<script type="text/javascript">
    //선택한 메뉴 보여줌.
    $(document).on("click", "div.nav > ul > li", function() {
        let selectedClass = this.classList;
        let contentList = $("div.content");
        for(let c of contentList) {
            c.classList.remove("pop");
        }
        $("div.content."+selectedClass[0]).addClass("pop");
    })
    //내정보. 처음비번확인
    $(document).on("click", ".btn.auth", function(){
        let editAuth = $("div.auth > input[type=password]")[0];
        let memberId = [[${#authentication.principal.memberId}]]+"";

        if(!isEmpty(editAuth.value)) { //비번칸 비어있지 않음
            $.ajax({
                method : "POST",
                url : "/members/mypage/pw-check/"+memberId,
                data : { memberPw : editAuth.value },
                dataType : "json"
            })
            .done(function(response) {
                if(response.result) {
                    $("div.auth").remove();
                    $("div.info").addClass("pop");
                    let memberLoginId = $(".memberLoginId")[0];
                    let memberEmail = $(".memberEmail")[0];
                    let memberName = $(".memberName")[0];
                    let memberTel = $(".memberTel")[0];
                    let memberZipCode = $(".memberZipcode")[0];
                    let memberAddress = $(".memberAddress")[0];
                    let memberDetailAddress = $(".memberDetailAddress")[0];
                    memberName.value= "[[${#authentication.principal.memberName}]]";
                    memberTel.value= "[[${#authentication.principal.memberTel}]]";
                    memberZipCode.value= "[[${#authentication.principal.memberZipCode}]]";
                    memberAddress.value= "[[${#authentication.principal.memberAddress}]]";
                    memberDetailAddress.value= "[[${#authentication.principal.memberDetailAddress}]]";

                    if("[[${#authentication.principal.memberSns}]]" === "memoryboost") { //일반유저
                        memberLoginId.value= "[[${#authentication.principal.memberLoginId}]]";
                        memberEmail.value= "[[${#authentication.principal.memberEmail}]]";
                    } else {
                        memberLoginId.remove();
                        memberEmail.remove();
                        $(".memberPw")[0].remove();
                        $(".memberPwConfirm")[0].remove();
                    }
                } else {
                    alert("비밀번호를 확인해주세요");
                }
            })
            .fail(function(response) {
                console.dir("통신 실패");
            });
        }
    });
    //input 변화 감지
    $(document).on("keyup", ".memberName, .memberDetailAddress", function(e) {
        if(isEmpty($(".memberName")[0].value)) {
            $(".chksum.name").removeClass("true").addClass("false");
            $(".btn.edit")[0].disabled = true;
        } else {
            $(".chksum.name").removeClass("false").addClass("true");
        }
        if(isEmpty($(".memberDetailAddress")[0].value)) {
            $(".chksum.detailaddr").removeClass("true").addClass("false");
            $(".btn.edit")[0].disabled = true;
        } else {
            $(".chksum.detailaddr").removeClass("false").addClass("true");
        }
        if(!isEmpty($(".memberName")[0].value) && !isEmpty($(".memberDetailAddress")[0].value)) {
            $(".btn.edit")[0].disabled = false;
        }
    });
    //내정보. 수정 눌렀을때 검증3
    $(document).on("click", ".btn.edit", function(e) {
        e.preventDefault();
        if("[[${#authentication.principal.memberSns}]]" == "memoryboost") { //일반유저
            let password = $(".memberPw")[0];
            let passwordConfirm = $(".memberPwConfirm")[0];

            if(!isEmpty(password.value) || isEmpty(!passwordConfirm.value)) { //비번을 바꾸려 할때
                if(!validatePassword(password, passwordConfirm)) {
                    alert("변경하려는 비밀번호를 확인해주세요");
                    return false;
                }
            }
        }

        let memberName = $(".memberName")[0];
        let memberDetailAddress = $(".memberDetailAddress")[0];
        let requestTo;
        let memberId = [[${#authentication.principal.memberId}]];
        if(validateName(memberName) && validateDetailAddress(memberDetailAddress)) { //이름, 주소 검증
            if("[[${#authentication.principal.memberSns}]]" == "memoryboost") { //일반유저
                requestTo = "/members/"+memberId;
            } else { //sns유저
                requestTo = "/members/sns/"+memberId;
            }
        }

        let params = $("form#edit-info").serializeObject();
        console.dir("전송");
        $.ajax({
            method : "put",
            url : requestTo,
            data : params
        })
        .done(function(response) {
            console.dir("전송완료");
            console.dir(response);
        })
        .fail(function(response) {
            console.dir("전송실패");
            console.dir(response);
        });
    });
</script>
<footer th:replace="footer.html"></footer>
</body>
</html>